\hypertarget{rdiff_8c}{}\section{/\+Users/\+Zheng/\+Desktop/librsync-\/0.9.7/rdiff.c File Reference}
\label{rdiff_8c}\index{/\+Users/\+Zheng/\+Desktop/librsync-\/0.\+9.\+7/rdiff.\+c@{/\+Users/\+Zheng/\+Desktop/librsync-\/0.\+9.\+7/rdiff.\+c}}
{\ttfamily \#include $<$config.\+h$>$}\\*
{\ttfamily \#include $<$stdlib.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$popt.\+h$>$}\\*
{\ttfamily \#include $<$zlib.\+h$>$}\\*
{\ttfamily \#include $<$bzlib.\+h$>$}\\*
{\ttfamily \#include \char`\"{}librsync.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}fileutil.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}util.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}trace.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}isprefix.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}snprintf.\+h\char`\"{}}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{rdiff_8c_a906afbfd1ce81a146b72d1ce928e7abb}{P\+R\+O\+G\+R\+A\+M}~\char`\"{}rdiff\char`\"{}
\end{DoxyCompactItemize}
\subsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
enum \{ \hyperlink{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7a1c677eb4324cc0e17007a0d81c337420}{O\+P\+T\+\_\+\+G\+Z\+I\+P} = 1069, 
\hyperlink{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7ae364cc42337e882efe36076e260e422d}{O\+P\+T\+\_\+\+B\+Z\+I\+P2}
 \}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{rdiff_8c_ad53223b8779f25caeddb70a3b9172967}{main} (const int argc, const char $\ast$argv\mbox{[}$\,$\mbox{]})
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{rdiff_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}{rs\+\_\+roll\+\_\+paranoia}
\item 
const struct \hyperlink{structpopt_option}{popt\+Option} \hyperlink{rdiff_8c_a3087600ee8cab9da450e9a7d893b5970}{opts} \mbox{[}$\,$\mbox{]}
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{rdiff_8c_a906afbfd1ce81a146b72d1ce928e7abb}{}\index{rdiff.\+c@{rdiff.\+c}!P\+R\+O\+G\+R\+A\+M@{P\+R\+O\+G\+R\+A\+M}}
\index{P\+R\+O\+G\+R\+A\+M@{P\+R\+O\+G\+R\+A\+M}!rdiff.\+c@{rdiff.\+c}}
\subsubsection[{P\+R\+O\+G\+R\+A\+M}]{\setlength{\rightskip}{0pt plus 5cm}\#define P\+R\+O\+G\+R\+A\+M~\char`\"{}rdiff\char`\"{}}\label{rdiff_8c_a906afbfd1ce81a146b72d1ce928e7abb}


Definition at line 72 of file rdiff.\+c.



\subsection{Enumeration Type Documentation}
\hypertarget{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7}{}\subsubsection[{anonymous enum}]{\setlength{\rightskip}{0pt plus 5cm}anonymous enum}\label{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7}
\begin{Desc}
\item[Enumerator]\par
\begin{description}
\index{O\+P\+T\+\_\+\+G\+Z\+I\+P@{O\+P\+T\+\_\+\+G\+Z\+I\+P}!rdiff.\+c@{rdiff.\+c}}\index{rdiff.\+c@{rdiff.\+c}!O\+P\+T\+\_\+\+G\+Z\+I\+P@{O\+P\+T\+\_\+\+G\+Z\+I\+P}}\item[{\em 
\hypertarget{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7a1c677eb4324cc0e17007a0d81c337420}{}O\+P\+T\+\_\+\+G\+Z\+I\+P\label{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7a1c677eb4324cc0e17007a0d81c337420}
}]\index{O\+P\+T\+\_\+\+B\+Z\+I\+P2@{O\+P\+T\+\_\+\+B\+Z\+I\+P2}!rdiff.\+c@{rdiff.\+c}}\index{rdiff.\+c@{rdiff.\+c}!O\+P\+T\+\_\+\+B\+Z\+I\+P2@{O\+P\+T\+\_\+\+B\+Z\+I\+P2}}\item[{\em 
\hypertarget{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7ae364cc42337e882efe36076e260e422d}{}O\+P\+T\+\_\+\+B\+Z\+I\+P2\label{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7ae364cc42337e882efe36076e260e422d}
}]\end{description}
\end{Desc}


Definition at line 83 of file rdiff.\+c.



\subsection{Function Documentation}
\hypertarget{rdiff_8c_ad53223b8779f25caeddb70a3b9172967}{}\index{rdiff.\+c@{rdiff.\+c}!main@{main}}
\index{main@{main}!rdiff.\+c@{rdiff.\+c}}
\subsubsection[{main(const int argc, const char $\ast$argv[])}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{const int}]{argc, }
\item[{const char $\ast$}]{argv\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}\label{rdiff_8c_ad53223b8779f25caeddb70a3b9172967}


Definition at line 367 of file rdiff.\+c.



\subsection{Variable Documentation}
\hypertarget{rdiff_8c_a3087600ee8cab9da450e9a7d893b5970}{}\index{rdiff.\+c@{rdiff.\+c}!opts@{opts}}
\index{opts@{opts}!rdiff.\+c@{rdiff.\+c}}
\subsubsection[{opts}]{\setlength{\rightskip}{0pt plus 5cm}const struct {\bf popt\+Option} opts\mbox{[}$\,$\mbox{]}}\label{rdiff_8c_a3087600ee8cab9da450e9a7d893b5970}
{\bfseries Initial value\+:}
\begin{DoxyCode}
= \{
    \{ \textcolor{stringliteral}{"verbose"},     \textcolor{charliteral}{'v'}, \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \textcolor{charliteral}{'v'} \},
    \{ \textcolor{stringliteral}{"version"},     \textcolor{charliteral}{'V'}, \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \textcolor{charliteral}{'V'} \},
    \{ \textcolor{stringliteral}{"input-size"},  \textcolor{charliteral}{'I'}, \hyperlink{popt_8h_a6b2e43ed233939be1eab7e9afd66db58}{POPT\_ARG\_INT},  &\hyperlink{buf_8c_a13d30eb003d6b9d3311435279879dd32}{rs\_inbuflen} \},
    \{ \textcolor{stringliteral}{"output-size"}, \textcolor{charliteral}{'O'}, \hyperlink{popt_8h_a6b2e43ed233939be1eab7e9afd66db58}{POPT\_ARG\_INT},  &\hyperlink{buf_8c_ade12a7fac722a79cf4c396cd2f7db6ff}{rs\_outbuflen} \},
    \{ \textcolor{stringliteral}{"help"},        \textcolor{charliteral}{'?'}, \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \textcolor{charliteral}{'h'} \},
    \{  0,            \textcolor{charliteral}{'h'}, \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \textcolor{charliteral}{'h'} \},
    \{ \textcolor{stringliteral}{"block-size"},  \textcolor{charliteral}{'b'}, \hyperlink{popt_8h_a6b2e43ed233939be1eab7e9afd66db58}{POPT\_ARG\_INT},  &block\_len \},
    \{ \textcolor{stringliteral}{"sum-size"},    \textcolor{charliteral}{'S'}, \hyperlink{popt_8h_a6b2e43ed233939be1eab7e9afd66db58}{POPT\_ARG\_INT},  &strong\_len \},
    \{ \textcolor{stringliteral}{"statistics"},  \textcolor{charliteral}{'s'}, \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, &show\_stats \},
    \{ \textcolor{stringliteral}{"stats"},        0,  \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, &show\_stats \},
    \{ \textcolor{stringliteral}{"gzip"},         0,  \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \hyperlink{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7a1c677eb4324cc0e17007a0d81c337420}{OPT\_GZIP} \},
    \{ \textcolor{stringliteral}{"bzip2"},        0,  \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, 0,             \hyperlink{rdiff_8c_adf764cbdea00d65edcd07bb9953ad2b7ae364cc42337e882efe36076e260e422d}{OPT\_BZIP2} \},
    \{ \textcolor{stringliteral}{"paranoia"},     0,  \hyperlink{popt_8h_a7759fe17e59c7fb08d33984d4683e4c0}{POPT\_ARG\_NONE}, &\hyperlink{rdiff_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}{rs\_roll\_paranoia} \},
    \{ 0 \}
\}
\end{DoxyCode}


Definition at line 89 of file rdiff.\+c.

\hypertarget{rdiff_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}{}\index{rdiff.\+c@{rdiff.\+c}!rs\+\_\+roll\+\_\+paranoia@{rs\+\_\+roll\+\_\+paranoia}}
\index{rs\+\_\+roll\+\_\+paranoia@{rs\+\_\+roll\+\_\+paranoia}!rdiff.\+c@{rdiff.\+c}}
\subsubsection[{rs\+\_\+roll\+\_\+paranoia}]{\setlength{\rightskip}{0pt plus 5cm}int rs\+\_\+roll\+\_\+paranoia}\label{rdiff_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}
2002-\/06-\/26\+: Donovan Baarda

The following is based entirely on pysync. It is much cleaner than the previous incarnation of this code. It is slightly complicated because in this case the output can block, so the main delta loop needs to stop when this happens.

In pysync a \textquotesingle{}last\textquotesingle{} attribute is used to hold the last miss or match for extending if possible. In this code, basis\+\_\+len and scoop\+\_\+pos are used instead of \textquotesingle{}last\textquotesingle{}. When basis\+\_\+len $>$ 0, last is a match. When basis\+\_\+len = 0 and scoop\+\_\+pos is $>$ 0, last is a miss. When both are 0, last is None (ie, nothing).

Pysync is also slightly different in that a \textquotesingle{}flush\textquotesingle{} method is available to force output of accumulated data. This \textquotesingle{}flush\textquotesingle{} is use to finalise delta calculation. In librsync input is terminated with an eof flag on the input stream. I have structured this code similar to pysync with a seperate flush function that is used when eof is reached. This allows for a flush style A\+P\+I if one is ever needed. Note that flush in pysync can be used for more than just terminating delta calculation, so a flush based A\+P\+I can in some ways be more flexible...

The input data is first scanned, then processed. Scanning identifies input data as misses or matches, and emits the instruction stream. Processing the data consumes it off the input scoop and outputs the processed miss data into the tube.

The scoop contains all data yet to be processed. The scoop\+\_\+pos is an index into the scoop that indicates the point scanned to. As data is scanned, scoop\+\_\+pos is incremented. As data is processed, it is removed from the scoop and scoop\+\_\+pos adjusted. Everything gets complicated because the tube can block. When the tube is blocked, no data can be processed. 

Definition at line 122 of file delta.\+c.

