\hypertarget{delta_8c}{}\section{/\+Users/\+Zheng/\+Desktop/librsync-\/0.9.7/delta.c File Reference}
\label{delta_8c}\index{/\+Users/\+Zheng/\+Desktop/librsync-\/0.\+9.\+7/delta.\+c@{/\+Users/\+Zheng/\+Desktop/librsync-\/0.\+9.\+7/delta.\+c}}
{\ttfamily \#include $<$config.\+h$>$}\\*
{\ttfamily \#include $<$assert.\+h$>$}\\*
{\ttfamily \#include $<$stdlib.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
{\ttfamily \#include \char`\"{}librsync.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}emit.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}stream.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}util.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}sumset.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}job.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}trace.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}search.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}types.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}rollsum.\+h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{delta_8c_ac4ddc31243c73ac413ac53efc2d86d69}{rs\+\_\+getinput} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job)
\item 
int \hyperlink{delta_8c_a6621916895913554a07a3545d9ea8587}{rs\+\_\+findmatch} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job, \hyperlink{librsync-config_8h_a6edddd44ca74c10ea65ef82d116e0ffa}{rs\+\_\+long\+\_\+t} $\ast$match\+\_\+pos, size\+\_\+t $\ast$match\+\_\+len)
\item 
\hyperlink{librsync_8h_a7feb858ceba3b8f3cf048d49be108253}{rs\+\_\+result} \hyperlink{delta_8c_a7570a0d3d1a68f581578b15a4741096e}{rs\+\_\+appendmatch} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job, \hyperlink{librsync-config_8h_a6edddd44ca74c10ea65ef82d116e0ffa}{rs\+\_\+long\+\_\+t} match\+\_\+pos, size\+\_\+t match\+\_\+len)
\item 
\hyperlink{librsync_8h_a7feb858ceba3b8f3cf048d49be108253}{rs\+\_\+result} \hyperlink{delta_8c_abf428c044f0e08094ed4a78dc41837c4}{rs\+\_\+appendmiss} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job, size\+\_\+t miss\+\_\+len)
\item 
\hyperlink{librsync_8h_a7feb858ceba3b8f3cf048d49be108253}{rs\+\_\+result} \hyperlink{delta_8c_a62eaed7486faf6e70d3708301df560b5}{rs\+\_\+appendflush} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job)
\item 
\hyperlink{librsync_8h_a7feb858ceba3b8f3cf048d49be108253}{rs\+\_\+result} \hyperlink{delta_8c_afc3d3aad47c9963e042508269ac3e513}{rs\+\_\+processmatch} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job)
\item 
\hyperlink{librsync_8h_a7feb858ceba3b8f3cf048d49be108253}{rs\+\_\+result} \hyperlink{delta_8c_a6d245f0e16f9144328805248892a694c}{rs\+\_\+processmiss} (\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$job)
\item 
\hyperlink{librsync_8h_a99e68494fe0ac6b84f4ecfb646690c35}{rs\+\_\+job\+\_\+t} $\ast$ \hyperlink{delta_8c_a65478298ed5fdebb7c91970d354e9ab3}{rs\+\_\+delta\+\_\+begin} (\hyperlink{librsync_8h_afb2a9cb505daeb8e519d06686f5caabf}{rs\+\_\+signature\+\_\+t} $\ast$sig)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{delta_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}{rs\+\_\+roll\+\_\+paranoia} = 0
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{delta_8c_a62eaed7486faf6e70d3708301df560b5}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+appendflush@{rs\+\_\+appendflush}}
\index{rs\+\_\+appendflush@{rs\+\_\+appendflush}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+appendflush(rs\+\_\+job\+\_\+t $\ast$job)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+result} rs\+\_\+appendflush (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_a62eaed7486faf6e70d3708301df560b5}
Flush any accumulating hit or miss, appending it to the delta. 

Definition at line 332 of file delta.\+c.

\hypertarget{delta_8c_a7570a0d3d1a68f581578b15a4741096e}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+appendmatch@{rs\+\_\+appendmatch}}
\index{rs\+\_\+appendmatch@{rs\+\_\+appendmatch}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+appendmatch(rs\+\_\+job\+\_\+t $\ast$job, rs\+\_\+long\+\_\+t match\+\_\+pos, size\+\_\+t match\+\_\+len)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+result} rs\+\_\+appendmatch (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job, }
\item[{{\bf rs\+\_\+long\+\_\+t}}]{match\+\_\+pos, }
\item[{size\+\_\+t}]{match\+\_\+len}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_a7570a0d3d1a68f581578b15a4741096e}
Append a match at match\+\_\+pos of length match\+\_\+len to the delta, extending a previous match if possible, or flushing any previous miss/match. 

Definition at line 284 of file delta.\+c.

\hypertarget{delta_8c_abf428c044f0e08094ed4a78dc41837c4}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+appendmiss@{rs\+\_\+appendmiss}}
\index{rs\+\_\+appendmiss@{rs\+\_\+appendmiss}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+appendmiss(rs\+\_\+job\+\_\+t $\ast$job, size\+\_\+t miss\+\_\+len)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+result} rs\+\_\+appendmiss (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job, }
\item[{size\+\_\+t}]{miss\+\_\+len}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_abf428c044f0e08094ed4a78dc41837c4}
Append a miss of length miss\+\_\+len to the delta, extending a previous miss if possible, or flushing any previous match.

This also breaks misses up into block\+\_\+len segments to avoid accumulating too much in memory. 

Definition at line 315 of file delta.\+c.

\hypertarget{delta_8c_a65478298ed5fdebb7c91970d354e9ab3}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+delta\+\_\+begin@{rs\+\_\+delta\+\_\+begin}}
\index{rs\+\_\+delta\+\_\+begin@{rs\+\_\+delta\+\_\+begin}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+delta\+\_\+begin(rs\+\_\+signature\+\_\+t $\ast$sig)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+job\+\_\+t}$\ast$ rs\+\_\+delta\+\_\+begin (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+signature\+\_\+t} $\ast$}]{sig}
\end{DoxyParamCaption}
)}\label{delta_8c_a65478298ed5fdebb7c91970d354e9ab3}
Prepare to compute a streaming delta. 

Definition at line 445 of file delta.\+c.

\hypertarget{delta_8c_a6621916895913554a07a3545d9ea8587}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+findmatch@{rs\+\_\+findmatch}}
\index{rs\+\_\+findmatch@{rs\+\_\+findmatch}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+findmatch(rs\+\_\+job\+\_\+t $\ast$job, rs\+\_\+long\+\_\+t $\ast$match\+\_\+pos, size\+\_\+t $\ast$match\+\_\+len)}]{\setlength{\rightskip}{0pt plus 5cm}int rs\+\_\+findmatch (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job, }
\item[{{\bf rs\+\_\+long\+\_\+t} $\ast$}]{match\+\_\+pos, }
\item[{size\+\_\+t $\ast$}]{match\+\_\+len}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_a6621916895913554a07a3545d9ea8587}
find a match at scoop\+\_\+pos, returning the match\+\_\+pos and match\+\_\+len. Note that this will calculate weak\+\_\+sum if required. It will also determine the match\+\_\+len.

Note that this routine could be modified to do xdelta style matches that would extend matches past block boundaries by matching backwards and forwards beyond the block boundaries. Extending backwards would require decrementing scoop\+\_\+pos as appropriate. 

Definition at line 257 of file delta.\+c.

\hypertarget{delta_8c_ac4ddc31243c73ac413ac53efc2d86d69}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+getinput@{rs\+\_\+getinput}}
\index{rs\+\_\+getinput@{rs\+\_\+getinput}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+getinput(rs\+\_\+job\+\_\+t $\ast$job)}]{\setlength{\rightskip}{0pt plus 5cm}void rs\+\_\+getinput (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job}
\end{DoxyParamCaption}
)}\label{delta_8c_ac4ddc31243c73ac413ac53efc2d86d69}


Definition at line 237 of file delta.\+c.

\hypertarget{delta_8c_afc3d3aad47c9963e042508269ac3e513}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+processmatch@{rs\+\_\+processmatch}}
\index{rs\+\_\+processmatch@{rs\+\_\+processmatch}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+processmatch(rs\+\_\+job\+\_\+t $\ast$job)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+result} rs\+\_\+processmatch (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_afc3d3aad47c9963e042508269ac3e513}
The scoop contains match data at scoop\+\_\+next of length scoop\+\_\+pos. This function processes that match data, returning R\+S\+\_\+\+D\+O\+N\+E if it completes, or R\+S\+\_\+\+B\+L\+O\+C\+K\+E\+D if it gets blocked. After it completes scoop\+\_\+pos is reset to still point at the next unscanned data.

This function currently just removes data from the scoop and adjusts scoop\+\_\+pos appropriately. In the future this could be used for something like context compressing of miss data. Note that it also calls rs\+\_\+tube\+\_\+catchup to output any pending output. 

Definition at line 363 of file delta.\+c.

\hypertarget{delta_8c_a6d245f0e16f9144328805248892a694c}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+processmiss@{rs\+\_\+processmiss}}
\index{rs\+\_\+processmiss@{rs\+\_\+processmiss}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+processmiss(rs\+\_\+job\+\_\+t $\ast$job)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf rs\+\_\+result} rs\+\_\+processmiss (
\begin{DoxyParamCaption}
\item[{{\bf rs\+\_\+job\+\_\+t} $\ast$}]{job}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{delta_8c_a6d245f0e16f9144328805248892a694c}
The scoop contains miss data at scoop\+\_\+next of length scoop\+\_\+pos. This function processes that miss data, returning R\+S\+\_\+\+D\+O\+N\+E if it completes, or R\+S\+\_\+\+B\+L\+O\+C\+K\+E\+D if it gets blocked. After it completes scoop\+\_\+pos is reset to still point at the next unscanned data.

This function uses rs\+\_\+tube\+\_\+copy to queue copying from the scoop into output. and uses rs\+\_\+tube\+\_\+catchup to do the copying. This automaticly removes data from the scoop, but this can block. While rs\+\_\+tube\+\_\+catchup is blocked, scoop\+\_\+pos does not point at legit data, so scanning can also not proceed.

In the future this could do compression of miss data before outputing it. 

Definition at line 385 of file delta.\+c.



\subsection{Variable Documentation}
\hypertarget{delta_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}{}\index{delta.\+c@{delta.\+c}!rs\+\_\+roll\+\_\+paranoia@{rs\+\_\+roll\+\_\+paranoia}}
\index{rs\+\_\+roll\+\_\+paranoia@{rs\+\_\+roll\+\_\+paranoia}!delta.\+c@{delta.\+c}}
\subsubsection[{rs\+\_\+roll\+\_\+paranoia}]{\setlength{\rightskip}{0pt plus 5cm}int rs\+\_\+roll\+\_\+paranoia = 0}\label{delta_8c_a9ae205d5a1d8a22f7369d19d57caa3c2}
2002-\/06-\/26\+: Donovan Baarda

The following is based entirely on pysync. It is much cleaner than the previous incarnation of this code. It is slightly complicated because in this case the output can block, so the main delta loop needs to stop when this happens.

In pysync a \textquotesingle{}last\textquotesingle{} attribute is used to hold the last miss or match for extending if possible. In this code, basis\+\_\+len and scoop\+\_\+pos are used instead of \textquotesingle{}last\textquotesingle{}. When basis\+\_\+len $>$ 0, last is a match. When basis\+\_\+len = 0 and scoop\+\_\+pos is $>$ 0, last is a miss. When both are 0, last is None (ie, nothing).

Pysync is also slightly different in that a \textquotesingle{}flush\textquotesingle{} method is available to force output of accumulated data. This \textquotesingle{}flush\textquotesingle{} is use to finalise delta calculation. In librsync input is terminated with an eof flag on the input stream. I have structured this code similar to pysync with a seperate flush function that is used when eof is reached. This allows for a flush style A\+P\+I if one is ever needed. Note that flush in pysync can be used for more than just terminating delta calculation, so a flush based A\+P\+I can in some ways be more flexible...

The input data is first scanned, then processed. Scanning identifies input data as misses or matches, and emits the instruction stream. Processing the data consumes it off the input scoop and outputs the processed miss data into the tube.

The scoop contains all data yet to be processed. The scoop\+\_\+pos is an index into the scoop that indicates the point scanned to. As data is scanned, scoop\+\_\+pos is incremented. As data is processed, it is removed from the scoop and scoop\+\_\+pos adjusted. Everything gets complicated because the tube can block. When the tube is blocked, no data can be processed. 

Definition at line 122 of file delta.\+c.

